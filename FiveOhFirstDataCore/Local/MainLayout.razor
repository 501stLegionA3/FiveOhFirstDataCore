@inherits LayoutComponentBase
@inject FiveOhFirstDataCore.Core.Services.IRosterService _roster

<main class="page min-vh-100">
    @if (Loaded)
    {
    <CascadingValue Value="CurrentUser">
        <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark align-items-stretch position-relative" style="width: 280px;">
            <NavMenu />
        </div>

        <div class="main">
            <div class="top-row px-4 auth">
                <LoginDisplay />
            </div>

            <div class="content px-4">
                @Body
            </div>
        </div>
    </CascadingValue>
    }
    else
    {
        <em>Loading...</em>
    }
</main>

@code {
    public Trooper? CurrentUser {get;set;} = null;
    public bool Loaded { get; set; } = false;

    private Task<Trooper?>? GetTrooperFromClaimTask { get; set; } = null;

    [CascadingParameter]
    public Task<AuthenticationState> AuthStateTask { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        var claims = (await AuthStateTask).User;

        if(GetTrooperFromClaimTask is null)
            GetTrooperFromClaimTask = _roster.GetTrooperFromClaimsPrincipalAsync(claims);

        CurrentUser = await GetTrooperFromClaimTask;

        Loaded = true;
    }
}